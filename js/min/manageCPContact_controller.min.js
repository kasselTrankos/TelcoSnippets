CNT.ngModule.controller("manageCPContactController",["manageCPContactService","$timeout","$stateParams","$scope","gettextCatalog","T3_CabeceraPresentacionService","T3_CommunicationService","T3_TrazaService","T3_StateService","$filter","PopupService","T3_StorageService","$parse",function(f,b,i,l,k,m,a,j,c,g,e,h,d){l.init=function(){l.showPersonContact=false;l.contTable=0;l.visibleNotification=false;l.visiblePerson=false;l.isVisiblePersonContact=false;l.isVisibleNotification=false;l.isOpenSpinner=false;l.spinners=[];l.lastSearch={};l.personContactMediumTypeCategory=null;l.notificationContactMediumTypeCategory=null;c.init(l,f,{CGT_ManageCPContact_IN:l.cgtManageCPContactIn||i.cgtManageCPContactIn});if(l.CGT_ManageCPContact_IN){l.manageCPContact()}l.loadMultilanguageNew();a.subscribe(l,"AlertLanguageChanged",l.loadMultilanguageNew)};l.getNameOfState=function(){return"cnt"+CNT.name.charAt(0).toUpperCase()+CNT.name.slice(1).toLowerCase()+"State"};l.setSetPreviousState=function(){var n=h.getItem({cgName:l.getNameOfState()});if(n!==void (0)&&n!==null&&n){if(n.categorizeDisagreementPolicies){l.lastSearch.categorizeDisagreementPolicies=n.categorizeDisagreementPolicies}if(n.listCPByPartyRoleAndCPType){l.lastSearch.listCPByPartyRoleAndCPType=n.listCPByPartyRoleAndCPType}if(n.categorizeImproperCustService){l.lastSearch.categorizeImproperCustService=n.categorizeImproperCustService}if(n.manageCPContact){if(n.manageCPContact){l.setStateData(n.manageCPContact)}}}};l.setStateData=function(n){l.cgtManageCPContactIn.businessInteractionRoles=n.businessInteractionRoles||[];if(l.cgtManageCPContactIn.businessInteractionRoles.length>0){l.drawBusinessInteractionRoles()}};l.putItem=function(){h.putItem({cgName:l.getNameOfState(),data:{categorizeImproperCustService:l.lastSearch.categorizeImproperCustService||{},categorizeDisagreementPolicies:l.lastSearch.categorizeDisagreementPolicies||{},listCPByPartyRoleAndCPType:l.lastSearch.listCPByPartyRoleAndCPType||{},manageCPContact:{businessInteractionRoles:l.lastSearch.businessInteractionRoles}}})};l.toString=function(n){return String(n)};l.drawBusinessInteractionRoles=function(n){var o=n||0;l.manageCPContactData.notifyPerson[o]=l.cgtManageCPContactIn.businessInteractionRoles[o].id;l.listContactMediumType(o)};l.manageCPContact=function(){var n={customerProblemType:{id:l.CGT_ManageCPContact_IN.customerProblemType.id}};l.openSpinner();f.manageCPContact(n).then(function(o){l.closeSpinner();l.ManageCPContact_OUT=o.cpcontactLists;l.applyDataFromManageCPContact();l.onLoaded()},function(o){l.closeSpinner();j.setTrazaError(CNT.name,"Se ha detectado un error "+o.code+" en la llamada al servicio manageCPContact.");var p={};if((o.code===500)&&(o.mensaje1!==undefined)&&(o.mensaje1!==null)){p.mensaje1=o.mensaje1;p.mensaje2=o.mensaje2;p.mensaje3=o.mensaje3}l.manageCPContactFunctionality.error=true})};l.loadMultilanguageNew=function(n){m.resolveTranslationsCG("manageCPContact",k.currentLanguage).then(function(o){l.selectPerson_translation=k.getString("manageCPContact-selPersonaContacto");l.selectContactMedium_translation=k.getString("manageCPContact-selMedioContactoPlain")},function(o){})};l.onLoaded=function(){l.selected={value:""};l.manageCPContactView={mediosContacto:[],personMediosContacto:[],tiposContacto:[],listPartyRoles_tipo2:[],tmp_listPartyRoles_tipo2:[],listPartyRoles_tipo3:[]};l.manageCPContactData={listaTemporal_1:[],listaTemporal:[],medioContacto:[],tipoContacto:[],notifyPerson:[],person:[],personMedioContacto:[]};l.medioSelectedSecond={value:""};l.personaSelected={};l.cgtManageCPContactIn.personMediumType={"@c":".ContactInteractionRole_DTO_IN",person:[],personMedioContacto:[]};l.cgtManageCPContactIn.businessInteractionRoles=[];l.action=l.CGT_ManageCPContact_IN.action;l.manageCPContactFunctionality={error:false};l.firstLoad=true;if(l.CGT_ManageCPContact_IN.customerProblem&&l.CGT_ManageCPContact_IN.customerProblem.id){l.getCPContactInteractionRole(l.CGT_ManageCPContact_IN)}else{l.getCPContactInteractionRole(l.CGT_ManageCPContact_IN)}};l.closeSpinner=function(){l.spinners.splice(-1,1);if(l.spinners.length===0){e.CloseSpinner();l.isOpenSpinner=false}};l.openSpinner=function(){l.spinners.push(1);if(!l.isOpenSpinner){l.isOpenSpinner=true;e.getSpinner(l)}};l.addFila=function(n,o){o=o||false;l.contTable++;l.manageCPContactView.filteredListPartyRoles=[];if(!l.firstLoad){var p=n+1;l.removeElement_fromLista2(l.manageCPContactData.notifyPerson[n]);l.manageCPContactData.tipoContacto[p]="";l.manageCPContactData.medioContacto[p]="";l.manageCPContactData.notifyPerson[p]="";l.manageCPContactData.listaTemporal.push(l.contTable);if(!o){l.addNewBusinessInteractionRolesData(l.manageCPContactData.notifyPerson,l.manageCPContactData.tipoContacto,l.manageCPContactData.medioContacto,n)}}else{l.manageCPContactData.listaTemporal.push(l.contTable);if(l.isVisiblePersonContact){l.manageCPContactData.listaTemporal_1.push(l.contTable)}l.firstLoad=false}};l.isIn_tmp_listPartyRoles_tipo2=function(n){return(l.manageCPContactView.tmp_listPartyRoles_tipo2.indexOf(n)>=0)};l.getFiltered=function(n,r){if(!r){return n}var p=[];var q=0;var o=n.length;for(q;q<o;q++){if(!l.isIn_tmp_listPartyRoles_tipo2(n[q].id)){p.push(n[q])}}return p};l.removeElement_fromLista2=function(r){var o=0;var q=null;var n=l.manageCPContactView.listPartyRoles_tipo2.length;var p=[];for(o;o<n;o++){if(l.manageCPContactView.listPartyRoles_tipo2[o].id===r){l.manageCPContactView.tmp_listPartyRoles_tipo2.push(l.manageCPContactView.listPartyRoles_tipo2[o].id)}}};l.findPersonContact_fromBussiness=function(){if(!l.cgtManageCPContactInbusinessInteractionRoles){l.cgtManageCPContactInbusinessInteractionRoles=[]}var o=0;var n=l.cgtManageCPContactIn.businessInteractionRoles.length;for(o;o<n;o++){if(l.cgtManageCPContactIn.businessInteractionRoles[o].type==="PersonContact"){return l.cgtManageCPContactIn.businessInteractionRoles[o]}}return false};l.clearBusinessInteractionRolesData=function(){if(l.cgtManageCPContactIn.businessInteractionRoles&&l.cgtManageCPContactIn.businessInteractionRoles.length){var p=0;var o=null;var n=l.cgtManageCPContactIn.businessInteractionRoles.length;for(p;p<n;p++){if(l.cgtManageCPContactIn.businessInteractionRoles[p].type){o=l.cgtManageCPContactIn.businessInteractionRoles[p]}}l.cgtManageCPContactIn.businessInteractionRoles.length=0;if(o!==null){l.cgtManageCPContactIn.businessInteractionRoles.push(o)}}};l.addNewBusinessInteractionRolesData=function(n,p,s,q){l.clearBusinessInteractionRolesData();var o=[];var r=0;for(r;r<=q;r++){var t=g("filter")(l.manageCPContactView.listPartyRoles_tipo2,{id:n[r]})[0];var u={"@c":t["@c"],id:t.id,interactionRoleType:{id:t.interactionRoleType.id},partyRole:{id:t.partyRole.id}};u.contactMedium=l.generateContactMedium(s[r],p[r]);l.cgtManageCPContactIn.businessInteractionRoles.push(u)}l.lastSearch.businessInteractionRoles=angular.copy(l.cgtManageCPContactIn.businessInteractionRoles);l.putItem()};l.generateContactMedium=function(o,n){var p={contactMediumType:{id:n}};if(o.id!==-1){p.id=o.id}else{p.value=o.value}return p};l.averiguarIdioma=function(r){var q=[{text:"es_ES",id:1},{text:"ca_CA",id:2},{text:"gl_GL",id:3},{text:"eu_EU",id:4},{text:"va_VA",id:5},{text:"en_EN",id:6},{text:"fr_FR",id:7},{text:"de_DE",id:8},{text:"it_IT",id:9}];var p=0;for(var o=0;o<q.length;o++){var n=q[o];if(n.text==r){p=n.id;break}}return p};l.borrarPersona=function(){l.cgtManageCPContactIn.personMediumType.person[0]=null;l.cgtManageCPContactIn.personMediumType.personMedioContacto[0]=null};l.cargaMedios=function(u,v){var r=0;var t=l.GetCPContactInteractionRole_OUT.cpcontactInteractionRole.businessInteractionRoles;var q=t.length;var x=l.manageCPContactData.notifyPerson;var p=l.manageCPContactView.mediosContacto;var n=(v!==void (0)&&v==="person");var s=g("filter")(l.manageCPContactView.tiposContacto[u],{id:l.manageCPContactData.tipoContacto[u]})[0];if(n){x=l.cgtManageCPContactIn.personMediumType.person;p=l.manageCPContactView.personMediosContacto}p[u]=[];for(r;r<q;r++){var o=(n)?"SMS":s.name.multiLanguages[0].value;if(t[r].contactMedium.contactMediumType.name===o&&t[r].partyRole.id===x[u]){p[u].push({value:t[r].contactMedium.value,id:t[r].contactMedium.id})}}t=l.GetCPContactInteractionRole_OUT.potencialCPContactInteractionRole.businessInteractionRoles;q=t.length;r=0;for(r;r<q;r++){var o=(n)?"SMS":s.name.multiLanguages[0].value;if(t[r].contactMedium.contactMediumType.name===o&&t[r].partyRole.id===x[u]){p[u].push({value:t[r].contactMedium.value,id:t[r].contactMedium.id})}}if(l.cgtManageCPContactIn&&l.cgtManageCPContactIn.businessInteractionRoles[u]&&l.cgtManageCPContactIn.businessInteractionRoles[u].contactMedium&&l.cgtManageCPContactIn.businessInteractionRoles[u].contactMedium.id){var w=g("filter")(l.manageCPContactView.mediosContacto[u],{id:l.cgtManageCPContactIn.businessInteractionRoles[u].contactMedium.id})[0];l.manageCPContactData.medioContacto[u]=w;l.addFila(u,true);if(l.cgtManageCPContactIn.businessInteractionRoles[u+1]){l.drawBusinessInteractionRoles(u+1)}}};l.cargaTipos=function(n){l.listContactMediumType(n)};l.desplegar=function(){l.visible=!l.visible};l.desplegarNotification=function(){l.visibleNotification=!l.visibleNotification};l.isUniquePerson=function(q,r){if(l.CGT_ManageCPContact_IN.action==="C"){return false}var p=0;var n=q.length;for(p;p<n;p++){if(q[p].id===r){return true}}return false};l.generatePersonData=function(o){var n={"@c":o["@c"],interactionRoleType:{id:o.interactionRoleType.id},contactMedium:{id:o.contactMedium.id,contactMediumType:{id:o.contactMedium.contactMediumType.id}},partyRole:{id:o.partyRole.id},contactMediumType:o.contactMedium.contactMediumType,id:o.partyRole.id,name:o.partyRole.party?o.partyRole.party.individualNameFormattedName||o.partyRole.party.organizationNameTradingName:null};if(l.CGT_ManageCPContact_IN.action==="C"){n.contactMedium.value=o.contactMedium.value}return n};l.filterDataByInteractionRoleType=function(q,r){var p=g("filter")(r,{interactionRoleType:{id:q}});var o=0;var n=p.length;for(o;o<n;o++){if(!l.isUniquePerson(l.manageCPContactView["listPartyRoles_tipo"+q],p[o].partyRole.id)){l.manageCPContactView["listPartyRoles_tipo"+q].push(l.generatePersonData(p[o]))}}};l.fillPersonsAfterLoad_getCPContactInteractionRole=function(){l.manageCPContactView.listPartyRoles_tipo2.length=0;l.manageCPContactView.listPartyRoles_tipo3.length=0;if(l.GetCPContactInteractionRole_OUT.cpcontactInteractionRole&&l.GetCPContactInteractionRole_OUT.cpcontactInteractionRole.businessInteractionRoles){l.filterDataByInteractionRoleType(2,l.GetCPContactInteractionRole_OUT.cpcontactInteractionRole.businessInteractionRoles);l.filterDataByInteractionRoleType(3,l.GetCPContactInteractionRole_OUT.cpcontactInteractionRole.businessInteractionRoles)}if(l.GetCPContactInteractionRole_OUT.potencialCPContactInteractionRole&&l.GetCPContactInteractionRole_OUT.potencialCPContactInteractionRole.businessInteractionRoles&&l.CGT_ManageCPContact_IN.action!=="C"){l.filterDataByInteractionRoleType(2,l.GetCPContactInteractionRole_OUT.potencialCPContactInteractionRole.businessInteractionRoles);l.filterDataByInteractionRoleType(3,l.GetCPContactInteractionRole_OUT.potencialCPContactInteractionRole.businessInteractionRoles)}l.showNotificationANDPersonContact=true;l.visible=true;l.addFila(0)};l.getCPContactInteractionRole=function(n){l.openSpinner();var o={};if(n.partyRole){o.partyRole=n.partyRole}if(n.customerProblem){o.customerProblem=n.customerProblem}f.getCPContactInteractionRole(o).then(function(p){l.closeSpinner();l.GetCPContactInteractionRole_OUT=p;l.fillPersonsAfterLoad_getCPContactInteractionRole();l.setSetPreviousState()},function(p){l.closeSpinner();j.setTrazaError(CNT.name,"Se ha detectado un error "+p.code+" en la llamada al servicio getCPContactInteractionRole.");var q={};if((p.code===500)&&(p.mensaje1!==undefined)&&(p.mensaje1!==null)){q.mensaje1=p.mensaje1;q.mensaje2=p.mensaje2;q.mensaje3=p.mensaje3}l.manageCPContactFunctionality.error=true})};l.getTranslate=function(n){if(n===void (0)){return""}var p=0;var o=n.length;for(p;p<o;p++){if(n[p]!==null&&n[p].languageCode!==null){if(n[p].languageCode===l.averiguarIdioma(k.currentLanguage)){return n[p].value}}}return""};l.listContactMediumType=function(o){var n={showAllLanguages:false,showActive:true,contactMediumTypeCategory:{id:l.notificationContactMediumTypeCategory}};l.openSpinner();f.listContactMediumType(n).then(function(p){l.closeSpinner();l.manageCPContactView.tiposContacto[o||0]=p.contactMediumTypes;if(l.cgtManageCPContactIn.businessInteractionRoles[o||0]&&l.cgtManageCPContactIn.businessInteractionRoles[o||0].contactMedium&&l.cgtManageCPContactIn.businessInteractionRoles[o||0].contactMedium.contactMediumType&&l.cgtManageCPContactIn.businessInteractionRoles[o||0].contactMedium.contactMediumType.id){l.manageCPContactData.tipoContacto[o||0]=Number(l.cgtManageCPContactIn.businessInteractionRoles[o||0].contactMedium.contactMediumType.id);l.cargaMedios(o||0)}},function(p){l.closeSpinner();j.setTrazaError(CNT.name,"Se ha detectado un error "+p.code+" en la llamada al servicio listContactMediumType.");var q={};if((p.code===500)&&(p.mensaje1!==undefined)&&(p.mensaje1!==null)){q.mensaje1=p.mensaje1;q.mensaje2=p.mensaje2;q.mensaje3=p.mensaje3}l.manageCPContactFunctionality.error=true})};l.applyDataFromManageCPContact=function(){var o=0;var n=l.ManageCPContact_OUT.length;for(o;o<n;o++){if(l.ManageCPContact_OUT[o].interactionRoleType.id===2){l.isVisibleNotification=l.visibleNotification=true;l.notificationContactMediumTypeCategory=l.ManageCPContact_OUT[o].contactMediumTypeCategory.id}if(l.ManageCPContact_OUT[o].interactionRoleType.id===3){l.isVisiblePersonContact=l.visiblePerson=true;l.personContactMediumTypeCategory=l.ManageCPContact_OUT[o].contactMediumTypeCategory.id}}};l.modalError=function(){var n={size:"sm",tipoModal:"error",tituloModal:"",textoPrincipal:k.getString("manageCPContact-principal-error"),textoSecundario:k.getString("manageCPContact-secundario-error"),textoPregunta:"",textoBtnAceptar:k.getString("manageCPContact-btnAceptar"),accionBtnAceptar:"cerrarPopup()",textoBtnCancelar:"",accionBtnCancelar:""};e.getPopupGeneric(l,"manageCPContactPopupController",n)};l.refreshResults=function(o){var p=o.search,r=angular.copy(o.items),q=-1;r=r.filter(function(s){return s.id!==q});if(!p){o.items=r}else{var n={id:q,name:p};o.items=[n].concat(r);o.selected=n}};l.refreshResultsMedios=function(o){var p=o.search,r=angular.copy(o.items),q=-1;r=r.filter(function(s){return s.id!==q});if(!p){o.items=r}else{var n={id:q,value:p};o.items=[n].concat(r);o.selected=n}};l.refreshResultsPersona=function(o){var p=o.search,r=angular.copy(o.items),q=-1;r=r.filter(function(s){return s.id!==q});if(!p){o.items=r}else{var n={id:q,name:p};o.items=[n].concat(r);o.selected=n}};l.removeFila=function(r,p){if(p){l.manageCPContactData.medioContacto[l.manageCPContactData.medioContacto.length-1]="";l.manageCPContactData.tipoContacto[l.manageCPContactData.tipoContacto.length-1]="";l.manageCPContactData.notifyPerson[l.manageCPContactData.notifyPerson.length]="";return false}var n=l.manageCPContactData.listaTemporal.indexOf(r);var o=l.manageCPContactView.tmp_listPartyRoles_tipo2.indexOf(l.manageCPContactData.notifyPerson[n]);if(o>=0){l.manageCPContactView.tmp_listPartyRoles_tipo2.splice(o,1)}if(n===0&&l.manageCPContactData.listaTemporal.length===1){l.manageCPContactData.medioContacto.length=0;l.manageCPContactData.tipoContacto.length=0;l.manageCPContactData.notifyPerson.length=0;l.cgtManageCPContactIn.businessInteractionRoles.length=0}else{var q=false;if(l.cgtManageCPContactIn.businessInteractionRoles[n]){l.cgtManageCPContactIn.businessInteractionRoles.splice(n,1);l.lastSearch.businessInteractionRoles=angular.copy(l.cgtManageCPContactIn.businessInteractionRoles);l.putItem()}l.manageCPContactData.medioContacto.splice(n,1);l.manageCPContactData.tipoContacto.splice(n,1);l.manageCPContactData.notifyPerson.splice(n,1);l.manageCPContactData.listaTemporal.splice(n,1)}};l.isPersonSelected=function(o,n){return(o&&o.id&&n&&n.id&&n.id===o.id)};l.regenerateArrayData=function(n,r){var q=0;var o=n.length;var p=[];var s={};for(q;q<o;q++){if(n[q]){s.id=n[q].id;if(r==="medio"){s.value=n[q].value}else{s["@c"]=n[q]["@c"];s.contactMedium=n[q].contactMedium;s.contactMediumType=n[q].contactMediumType;s.interactionRoleType=n[q].interactionRoleType;s.partyRole=n[q].partyRole;s.name=n[q].name}}p.push(s)}return p}}]).controller("manageCPContactPopupController",["$scope","$modalInstance",function(a,b){a.cerrarPopup=function(){b.close()}}]);